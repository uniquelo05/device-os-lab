# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Explicit tag filters to trigger workflows on tags
tag_filters: &tag_filters
  filters:
    tags:
      only:
        - /.+/

orbs:
  win: circleci/windows@2.4.0
  macos: circleci/macos@2.4.1

aliases:
  - &tasks ["compile:all clean:all", "compile:user clean:user", "compile:debug clean:debug"]
  - &platforms ["argon", "boron", "esomx", "bsom", "b5som", "tracker", "p2", "trackerm", "msom", "electron2"]

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  setup-workspace:
    machine:
      image: ubuntu-2004:current
    resource_class: medium+ # Upgraded resource class for faster execution
    steps:
      - checkout
      - run:
          name: "Install Dependencies"
          command: |
            sudo apt-get update && sudo apt-get install -y build-essential
      - run:
          name: "Create Tested Platforms Files in Workspace"
          command: |
            mkdir -p $HOME/workspace/tested-platforms
            ls -la $HOME/workspace
            ls -la $HOME/workspace/tested-platforms
            echo ":::: done!"
      - persist_to_workspace:
          root: ~/workspace
          paths:
            - tested-platforms
  validate-toolchain-platforms:
    machine:
      image: ubuntu-2004:current
    resource_class: medium+
    steps:
      - attach_workspace:
          at: ~/workspace
      - run:
          name: "Validate Toolchain"
          command: |
            echo "Validating toolchain..."
            make validate
workflows:
  version: 2
  build-and-test:
    jobs:
      - setup-workspace
      - validate-toolchain-platforms:
          requires:
            - setup-workspace

